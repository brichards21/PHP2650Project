new
previous_datat2 <- read_csv("T2 & T3 Sub List (updated 04-09-2022) - Tier 2.csv") %>%
dplyr::rename(subscribe_date = subscribe_date_time) %>%
mutate(sub_type = "recurring")
previous_datat3 <- read_csv("T2 & T3 Sub List (updated 04-09-2022) - Tier 3.csv") %>%
dplyr::rename(subscribe_date = subscribe_date_time) %>%
mutate(sub_type = "recurring")
previous_data <- rbind(previous_datat2, previous_datat3)
new_data <- read_excel("KyleTier2_3subs.xlsx")
update_data <- function(old, new) {
old <- old %>%
clean_names() %>%
mutate(subscribe_date = as.Date(subscribe_date))
# added because of TZ formatting of last dataset
new <- new %>%
clean_names() %>%
mutate(subscribe_date = as.Date(as.POSIXct(subscribe_date)))
new$updated_sub_date <- new$subscribe_date
for (i in 1:nrow(new)) {
if (
nrow(merge(new[new$username == new$username[i] & new$current_tier == new$current_tier[i], ][, c('username', 'current_tier')], old[, c('username', 'current_tier')])) > 0 &&
(old[old$username == new$username[i] & old$current_tier == new[new$username == new$username[i], ]$current_tier, ]$sub_type != "gift") &&
(new$subscribe_date[i] != old[old$username == new$username[i] & old$current_tier == new$current_tier[i], ]$subscribe_date)) {
new$updated_sub_date[i] <- old[old$username == new$username[i] & old$current_tier == new$current_tier[i], ]$subscribe_date
}
}
new <- new %>%
arrange(updated_sub_date)
return(new)
}
updated <- update_data(previous_data, new_data)
updated
# check for lapsed subs that resubbed
updated %>%
filter(subscribe_date != updated_sub_date)
all(updated$subscribe_date == updated$updated_sub_date)
# only t3s
t3 <- updated %>%
filter(current_tier == "Tier 3" &
!(username %in% c("kylephillipsfun",
"mrskphil01")) &
sub_type != "gift") %>%
select(username, updated_sub_date, current_tier) %>%
dplyr::rename(subscribe_date = updated_sub_date) %>%
arrange(subscribe_date)
write.csv(t3, "tier3_list_05-01-2022.csv")
t3
t2 <- updated %>%
filter(current_tier == "Tier 2" &
sub_type != "gift") %>%
select(username, updated_sub_date, current_tier) %>%
dplyr::rename(subscribe_date = updated_sub_date) %>%
arrange(subscribe_date)
# select(username, subscribe_date)
write.csv(t2, "tier2_list_04-09-2022.csv")
t2 <- updated %>%
filter(current_tier == "Tier 2" &
sub_type != "gift") %>%
select(username, updated_sub_date, current_tier) %>%
dplyr::rename(subscribe_date = updated_sub_date) %>%
arrange(subscribe_date)
# select(username, subscribe_date)
write.csv(t2, "tier2_list_05-01-2022.csv")
t3
onetime <- read_csv("T2 & T3 Sub List (updated 04-09-2022) - Tier 3 (1).csv")
onetime
onetime <- read_csv("T2 & T3 Sub List (updated 04-09-2022) - Tier 3 (1).csv") %>%
arrange(subscribe_date)
onetime
write.csv(onetime, "tier3_list_05-01-2022.csv")
onetime <- read_csv("T2 & T3 Sub List (updated 04-09-2022) - Tier 3 (1).csv") %>%
arrange(subscribe_date) %>%
select(username, updated_sub_date, current_tier)
onetime <- read_csv("T2 & T3 Sub List (updated 04-09-2022) - Tier 3 (1).csv") %>%
arrange(subscribe_date) %>%
dplyr::select(username, updated_sub_date, current_tier)
onetime <- read_csv("T2 & T3 Sub List (updated 04-09-2022) - Tier 3 (1).csv") %>%
arrange(subscribe_date) %>%
dplyr::select(username, subscribe_date, current_tier)
write.csv(onetime, "tier3_list_05-01-2022.csv")
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
library(tidyverse)
library(lubridate)
library(ical)
library(kableExtra)
library(janitor)
library(reshape2)
library(data.table)
library(ggplot2)
library(ggthemes)
library(gganimate)
library(gifski)
library(survival)
library(randomForestSRC)
library(readr)
library(tidyverse)
library(tidyr)
pbc_rf <- rfsrc(Surv(years, status) ~ ., data = pbc,
nsplit = 10,
na.action = "na.impute")
pbc_rf <- rfsrc(Surv(years, status) ~ ., data = pbc)
pbc
pbc_use <- pbc %>%
mutate(status = as.factor(ifelse(status == 2, 1, 0)))
pbc_use
pbc_rf <- rfsrc(Surv(years, status) ~ ., data = pbc_use)
library(randomForestSRC)
pbc_rf <- randomForestSRC::rfsrc(Surv(years, status) ~ ., data = pbc_use)
pbc_use
pbc
colnames(pbc)
pbc_rf <- randomForestSRC::rfsrc(Surv(time, status) ~ ., data = pbc_use)
pbc_rf
pbc.cox <- coxph(Surv(time, status) ~ ., data =  pbc_use)
pbc_use
length(unique(id))
length(unique(pbc_use$id))
pbc_use <- pbc %>%
mutate(status = as.factor(ifelse(status == 2, 1, 0))) %?%
select(-id)
pbc_use <- pbc %>%
mutate(status = as.factor(ifelse(status == 2, 1, 0))) %>%
select(-id)
pbc.cox <- coxph(Surv(time, status) ~ ., data =  pbc_use)
pbc_use
pbc_use <- pbc %>%
mutate(status = as.factor(ifelse(status == 2, 1, 0))) %>%
select(-id)
pbc_use$trt <- as.factor(pbc_use$trt)
pbc_use$ascites <- as.factor(pbc_use$ascites)
pbc_use$hepato <- as.factor(pbc_use$hepato)
pbc_use$spiders <- as.factor(pbc_use$spiders)
pbc.cox <- coxph(Surv(time, status) ~ ., data =  pbc_use)
pbc_use
pbc_use <- pbc %>%
mutate(status = as.int(ifelse(status == 2, 1, 0))) %>%
select(-id)
pbc_use <- pbc %>%
mutate(status = as.integer(ifelse(status == 2, 1, 0))) %>%
select(-id)
pbc_use$trt <- as.factor(pbc_use$trt)
pbc_use$ascites <- as.factor(pbc_use$ascites)
pbc_use$hepato <- as.factor(pbc_use$hepato)
pbc_use$spiders <- as.factor(pbc_use$spiders)
pbc.cox <- coxph(Surv(time, status) ~ ., data =  pbc_use)
pbc.cox
pbc_use
pbc.cox2 <- coxph(Surv(time, status) ~ . - alk.phos, data = pbc_use)
pbc.cox2
pbc.cox3 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato, data = pbc_use)
pbc.cox3
pbc.cox4 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato - ascites, data = pbc_use)
pbc.cox4
pbc.cox5 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato - ascites - spiders, data = pbc_use)
pbc.cox5
pbc.cox6 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato - ascites - spiders -
trt, data = pbc_use)
pbc.cox6
pbc.cox7 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato - ascites - spiders -
trt - trig, data = pbc_use)
pbc.cox7
pbc.cox8 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato - ascites - spiders -
trt - trig - platelet, data = pbc_use)
pbc.cox8
pbc.cox9 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato - ascites - spiders -
trt - trig - platelet - sex, data = pbc_use)
pbc.cox9
pbc.cox10 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato - ascites - spiders -
trt - trig - platelet - sex -
chol, data = pbc_use)
pbc.cox10
pbc_use
pbc.int1 <- coxph(Surv(time, status) ~ (. - alk.phos -
hepato - ascites - spiders -
trt - trig - platelet - sex -
chol, data = pbc_use)^2)
pbc.int1 <- coxph(Surv(time, status) ~ (. - alk.phos -
hepato - ascites - spiders -
trt - trig - platelet - sex -
chol)^2, data = pbc_use)
pbc.int1
pbc_use <- pbc_use %>%
select(-c(alk.phos, hepato, ascites, spiders,
trt, trig, platelet, sex, chol))
pbc.int1 <- coxph(Surv(time, status) ~ (.)^2, data = pbc_use)
pbc.int1
pbc.int1 <- coxph(Surv(time, status) ~ (. - bili:protime)^2, data = pbc_use)
pbc.int1 <- coxph(Surv(time, status) ~ (.)^2, data = pbc_use)
pbc.int2 <- coxph(Surv(time, status) ~ (. - bili:protime)^2, data = pbc_use)
pbc.int2
pbc.int2 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime, data = pbc_use)
pbc.int2
pbc.int2 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage, data = pbc_use)
pbc.int2 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime,
data = pbc_use)
pbc.int3 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage, data = pbc_use)
pbc.int3
pbc.int4 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin, data = pbc_use)
pbc.int4
pbc.int5 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime, data = pbc_use)
pbc.int5
pbc.int6 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast, data = pbc_use)
pbc.int6
pbc.int7 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage, data = pbc_use)
pbc.int7
pbc.int8 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage, data = pbc_use)
pbc.int8
pbc.int9 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast, data = pbc_use)
pbc.int9
pbc.int10 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime, data = pbc_use)
pbc.int10
pbc.int11 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage, data = pbc_use)
pbc.int11 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage, data = pbc_use)
pbc.int11
pbc.int12 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast, data = pbc_use)
pbc.int12
pbc.int13 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin, data = pbc_use)
pbc.int13
pbc.int14 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin - copper:stage, data = pbc_use)
pbc.int14
pbc.int15 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin - copper:stage -
bili:albumin, data = pbc_use)
pbc.int15
pbc.int16 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin - copper:stage -
bili:albumin - edema:bili, data = pbc_use)
pbc.int16
pbc.int17 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin - copper:stage -
bili:albumin - edema:bili -
age:protime, data = pbc_use)
pbc.int17 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin - copper:stage -
bili:albumin - edema:bili -
age:protime, data = pbc_use)
pbc.int17
pbc.int18 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin - copper:stage -
bili:albumin - edema:bili -
age:protime - edema:copper, data = pbc_use)
pbc.int18 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin - copper:stage -
bili:albumin - edema:bili -
age:protime - edema:copper, data = pbc_use)
pbc.int18
pbc.int18
pbc.int19 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin - copper:stage -
bili:albumin - edema:bili -
age:protime - edema:copper -
bili:copper, data = pbc_use)
pbc.int19 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin - copper:stage -
bili:albumin - edema:bili -
age:protime - edema:copper -
bili:copper, data = pbc_use)
pbc.int19
pbc.int20
pbc.int20 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin - copper:stage -
bili:albumin - edema:bili -
age:protime - edema:copper -
bili:copper - protime:stage, data = pbc_use)
pbc.int20
pbc.int21 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin - copper:stage -
bili:albumin - edema:bili -
age:protime - edema:copper -
bili:copper - protime:stage -
age:ast, data = pbc_use)
pbc.int21
pbc.int22 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin - copper:stage -
bili:albumin - edema:bili -
age:protime - edema:copper -
bili:copper - protime:stage -
age:ast - albumin:copper, data = pbc_use)
pbc.int22
pbc.int23 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin - copper:stage -
bili:albumin - edema:bili -
age:protime - edema:copper -
bili:copper - protime:stage -
age:ast - albumin:copper -
age:bili, data = pbc_use)
pbc.int23
pbc.int24 <- coxph(Surv(time, status) ~ (.)^2 - bili:protime -
ast:stage - edema:albumin -
edema:protime - copper:ast -
albumin:stage - edema:stage -
albumin:ast - copper:protime -
age:stage - edema:ast -
age:albumin - copper:stage -
bili:albumin - edema:bili -
age:protime - edema:copper -
bili:copper - protime:stage -
age:ast - albumin:copper -
age:bili - ast:protime, data = pbc_use)
pbc.full <- coxph(Surv(time, status) ~ (.)^2, data =  pbc_use)
step(pbc.full, direction = "backward")
pbc_use <- pbc %>%
mutate(status = as.integer(ifelse(status == 2, 1, 0))) %>%
select(-id)
pbc_use$trt <- as.factor(pbc_use$trt)
pbc_use$ascites <- as.factor(pbc_use$ascites)
pbc_use$hepato <- as.factor(pbc_use$hepato)
pbc_use$spiders <- as.factor(pbc_use$spiders)
pbc.full <- coxph(Surv(time, status) ~ (.)^2, data =  pbc_use)
step(pbc.full, direction = "backward")
pbc_use <- pbc %>%
mutate(status = as.integer(ifelse(status == 2, 1, 0))) %>%
select(-id)
pbc_use$trt <- as.factor(pbc_use$trt)
pbc_use$ascites <- as.factor(pbc_use$ascites)
pbc_use$hepato <- as.factor(pbc_use$hepato)
pbc_use$spiders <- as.factor(pbc_use$spiders)
pbc.cox2 <- coxph(Surv(time, status) ~ . - alk.phos, data = pbc_use)
pbc.cox3 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato, data = pbc_use)
pbc.cox4 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato - ascites, data = pbc_use)
pbc.cox5 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato - ascites - spiders, data = pbc_use)
pbc.cox6 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato - ascites - spiders -
trt, data = pbc_use)
pbc.cox7 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato - ascites - spiders -
trt - trig, data = pbc_use)
pbc.cox8 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato - ascites - spiders -
trt - trig - platelet, data = pbc_use)
pbc.cox9 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato - ascites - spiders -
trt - trig - platelet - sex, data = pbc_use)
pbc.cox10 <- coxph(Surv(time, status) ~ . - alk.phos -
hepato - ascites - spiders -
trt - trig - platelet - sex -
chol, data = pbc_use)
pbc_use <- pbc_use %>%
select(-c(alk.phos, hepato, ascites, spiders,
trt, trig, platelet, sex, chol))
# test two-way interactions
pbc.full <- coxph(Surv(time, status) ~ (.)^2, data =  pbc_use)
step(pbc.full, direction = "backward")
coxph(Surv(time, status) ~ trt, data =  pbc)
pbc_cox <- coxph(Surv(time, status) ~ age + edema + bili + albumin +
copper + ast + protime + stage + age:edema + age:copper +
bili:ast + bili:stage + albumin:protime + ast:protime,
data = pbc_use)
pbc_cox
coxph(Surv(time, status) ~ age + edema + bili + albumin +
copper + ast + protime + stage + age:edema + age:copper +
bili:ast + bili:stage + albumin:protime,
data = pbc_use)
coxph(Surv(time, status) ~ age + edema + bili + albumin +
copper + ast + protime + stage + age:edema + age:copper +
bili:ast + albumin:protime,
data = pbc_use)
coxph(Surv(time, status) ~ age + edema + bili + albumin +
copper + ast + protime + stage + age:edema + age:copper +
bili:ast,
data = pbc_use)
pbc_cox2 <- coxph(Surv(time, status) ~ age + edema + bili + albumin +
copper + ast + protime + stage + age:edema + age:copper +
bili:ast,
data = pbc_use)
BIC(pbc_cox)
BIC(pbc_cox2)
BIC(pbc_cox)
BIC(pbc_cox2)
AIC(pbc_cox)
AIC(pbc_cox2)
BIC(pbc_cox)
BIC(pbc_cox2)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
library(tidyverse)
library(lubridate)
library(kableExtra)
library(janitor)
library(reshape2)
library(data.table)
library(ggplot2)
library(ggthemes)
library(gganimate)
library(gifski)
library(survival)
library(randomForestSRC)
library(readr)
library(tidyverse)
library(tidyr)
turnover <- read_csv("data/turnover.csv")
